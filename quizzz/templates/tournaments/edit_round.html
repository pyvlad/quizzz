{% extends 'base.html' %}

{% block title %}
  {% if data.round.id %}Edit Round{% else %}New Round{% endif %}
  - {{ g.group.name }}
{% endblock %}

{% block content %}
  <div class="container">
    <div class="row">
      <div class="col-12 col-sm-8 col-sm-offset-2 col-md-6 col-md-offset-3">
        <div class="paper-sm bg-grey p-2 p-md-4 my-2">
          <div class="form">

            <div class="form__header">
              {{ (data.round.id and "Edit Round") or "New Round" }}
            </div>

            <div class="form__item">
              <div class="form__help">
                Please fill in the form below and hit 'save'.<br/>
              </div>
            </div>

            <div class="form__item">
              <div class="form__label">
                <label for="tournament_name">Tournament Name</label>
              </div>
              <input class="form__input"
                name="tournament_name"
                id="tournament_name"
                type="text"
                value="{{ data.tournament.name }}"
                disabled
              />
            </div>

            <form id="form" action="" method="post">

              {{ empty_form.hidden_tag() }}

              <div class='form__item'>
                <label class="form__label" for="selectQuiz">Select Quiz</label>
                <input id="selectedQuizId" hidden/>
                <div id="selectQuiz"></div>
              </div>

              <div class="form__item">
                <div class="form__label">
                  Start Time
                </div>
                <div class="form__input-help">
                  Select the time (your local time) when quiz will become available for play.
                </div>
                <div id="start_time"></div>
              </div>

              <div class="form__item">
                <div class="form__label">
                  Finish Time
                </div>
                <div class="form__input-help">
                  Select the time (your local time) when quiz will stop being available for play.
                </div>
                <div id="finish_time"></div>
              </div>

              <div class='form__item text-centered'>
                <button class="btn btn--secondary btn--mw200">Save</button>
              </div>

            </form>

            {% if data.round.id %}
              <form action="{{ url_for('tournaments.delete_round', round_id=data.round.id) }}"
                    method="post">

                {{ empty_form.hidden_tag() }}

                <div class='form__item text-centered'>
                  <button class="btn btn--red btn--mw200"
                          onclick="return confirm('Are you sure?');">
                    Delete
                  </button>
                </div>
              </form>
            {% endif %}

          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


{% block bottom %}
<script>
  const renderQuizSelector = (quizId, quizPool) => {


    const makeTableRow = (quiz, num, onSelectQuiz) => {
      const tr = document.createElement("tr");
      tr.className = "table__tr";
      tr.classList.add(((num + 1) % 2) ? "table__tr--odd" : "table__tr--even");

      let td;

      td = document.createElement("td");
      td.className = "table__td";
      td.innerHTML = quiz.author;
      tr.append(td);

      td = document.createElement("td");
      td.className = "table__td";
      td.innerHTML = quiz.topic;
      tr.append(td);

      td = document.createElement("td");
      td.className = "table__td table__td--centered";
      const momentObj = moment(quiz.time_submitted);
      td.innerHTML = momentObj.format("YYYY-MM-DD HH:mm");
      tr.append(td);

      tr.onclick = () => onSelectQuiz(quiz.id);

      return tr;
    }


    const makeQuizPoolTable = (quizPool, onSelectQuiz) => {
      // table with choices
      const table = document.createElement("table");
      table.className = "table table--full-width";

      // column names
      const thead = document.createElement("thead");
      thead.innerHTML = `<tr>
          <th width="25%">Author</th>
          <th width="35%">Name</th>
          <th width="40%">Submitted</th>
        </tr>`;
      table.append(thead);

      // quiz pool
      const tbody = document.createElement("tbody");
      if (!quizPool.length) {
        const tr = document.createElement("tr");
        tr.className = "table__tr table__tr--odd";
        tr.innerHTML = '<td class="table__td" colspan="3">No quizzes available.</td>';
        tbody.append(tr);
      } else {
        quizPool.forEach((r,i) => {
          tbody.append(makeTableRow(r, i, onSelectQuiz));
        })
      }
      table.append(tbody);

      return table;
    }


    const makeSelectedQuizTable = (selectedQuiz) => {
      // table with selection
      const table = document.createElement("table");
      table.className = "table table--full-width table--colorful";

      const thead = document.createElement("thead");
      const tr = document.createElement("tr");
      if (selectedQuiz) {
        const momentObj = moment(selectedQuiz.time_submitted);
        const quizTime = momentObj.format("YYYY-MM-DD HH:mm");
        tr.innerHTML = `
            <th width="25%">${selectedQuiz.author}</th>
            <th width="35%">${selectedQuiz.topic}</th>
            <th width="40%">${quizTime}</th>`;
      } else {
        tr.innerHTML = '<th colspan="3">No quiz selected.</th>';
      }
      thead.append(tr);
      table.append(thead);

      return table;
    }


    const makeContainer = (quizPool, selectedQuizId, onSelectQuiz) => {
      let selectedQuiz = quizPool.filter(q => q.id === selectedQuizId);
      selectedQuiz = (selectedQuiz.length) ? selectedQuiz[0] : null;

      // container
      const div = document.createElement("div");
      // table with selected quiz
      const table1 = makeSelectedQuizTable(selectedQuiz);
      div.append(table1);
      // header
      const help = document.createElement("button");
      help.className = "btn btn--grey my-2";
      help.innerHTML = "Show quiz pool";
      function toggleQuizPool(e) {
        e.preventDefault();
        if (table2.hidden) {
          table2.hidden = false;
          this.innerHTML = "Hide quiz pool";
        } else {
          table2.hidden = true;
          this.innerHTML = "Show quiz pool";
        }
      }
      help.onclick = toggleQuizPool;
      div.append(help);
      // table with quiz pool
      const table2 = makeQuizPoolTable(quizPool, onSelectQuiz);
      table2.hidden = true;
      div.append(table2);

      return div;
    }


    const handleSelectQuiz = (quizId) => {
      document.querySelector("#selectedQuizId").value = quizId;
      const container = makeContainer(quizPool, quizId, handleSelectQuiz);  // closure
      const parent = document.querySelector("#selectQuiz");
      parent.innerHTML = "";
      parent.append(container);
    }

    // initial selection
    handleSelectQuiz(quizId);
  }



  const setTimeToMidnight = (hoursInputId, minutesInputId) => {
    /* Note:
    Gecko notes
    Using setAttribute() to modify certain attributes, most notably value in XUL,
    works inconsistently, as the attribute specifies the default value.
    To access or modify the current values, you should use the properties.
    For example, use Element.value instead of Element.setAttribute().
    https://developer.mozilla.org/en-US/docs/Web/API/Element/setAttribute
    */
    document.querySelector(hoursInputId).value = "0";
    document.querySelector(minutesInputId).value = "0";
  }


  const makeDateTimeSelectorHTML = (prefix, timestamp) => {
    const obj = moment(timestamp);
    const dateValue = obj.format("YYYY-MM-DD");
    const hoursValue = obj.format("HH");
    const minutesValue = obj.format("mm");

    return (
      `<div class="container">
        <div class="row">
        <div class="col-6">
          <div class="form__input-help">date</div>
          <input class="form__input" type="date"
              id="${prefix}_date" name="${prefix}_date" value="${dateValue}">
        </div>
        <div class="col-offset-1 col-2">
          <div class="form__input-help">hours</div>
          <input class="form__input" type="number" min="0" max="23" required
              id="${prefix}_hours" name="${prefix}_hours" value="${hoursValue}">
        </div>
        <div class="col-offset-1 col-2">
          <div class="form__input-help">minutes</div>
          <input class="form__input" type="number" min="0" max="59" required
              id="${prefix}_minutes" name="${prefix}_minutes" value="${minutesValue}">
        </div>
        </div>
        <div class="row">
          <div class="col-offset-7 col-5">
            <div class="link link--grey text-small text-centered"
              onclick="setTimeToMidnight('#${prefix}_hours', '#${prefix}_minutes')">
              set to midnight
            </div>
          </div>
        </div>
      </div>`
    )
  }


  const getDateTimeValue = (prefix) => {
    const dt = new Date(document.querySelector(`#${prefix}_date`).value);
    dt.setHours(document.querySelector(`#${prefix}_hours`).value);
    dt.setMinutes(document.querySelector(`#${prefix}_minutes`).value);
    return dt.toISOString().split('.')[0] + "Z";
  }


  const getFormData = () => {
    formData = {
      "quiz_id": document.querySelector("#selectedQuizId").value || null,
      "start_time": getDateTimeValue("start_time"),
      "finish_time": getDateTimeValue("finish_time"),
    }
    return formData;
  }


  document.addEventListener("DOMContentLoaded", () => {
    let quizId = {{ data.selected.quiz_id|tojson }};
    let startTimeUTC = {{ data.selected.start_time_utc|tojson }};
    let finishTimeUTC = {{ data.selected.finish_time_utc|tojson }};
    let quizPool = {{ data.quiz_pool|tojson }};

    renderQuizSelector(quizId, quizPool);

    const startTimeSelectorHTML = makeDateTimeSelectorHTML("start_time", startTimeUTC);
    document.getElementById("start_time").innerHTML = startTimeSelectorHTML;

    const finishTimeSelectorHTML = makeDateTimeSelectorHTML("finish_time", finishTimeUTC);
    document.getElementById("finish_time").innerHTML = finishTimeSelectorHTML;

    const form = document.getElementById("form");
    form.onsubmit = (e) => {
      e.preventDefault();

      // create new form using main form's data
      let newForm = document.createElement('form');
      newForm.action = form.action;
      newForm.method = form.method;
      let csrfToken = form.elements.csrf_token.value;
      let formData = getFormData();
      newForm.innerHTML = (
        `<input name="csrf_token" type="hidden" value="${csrfToken}">
        <input name="quiz_id" value="${formData.quiz_id}">
        <input name="start_time" value="${formData.start_time}">
        <input name="finish_time" value="${formData.finish_time}">`
      );
      // the form must be in the document to submit it
      document.body.append(newForm);
      // submit new form
      newForm.submit();
    }
  });

</script>
{% endblock %}
