{% extends 'base.html' %}

{% block title %}{{ data.tournament.name }} Tournament - {{g.group.name}}{% endblock %}

{% block header %}
  {{
    render_header([
      ("Groups", url_for("groups.index")),
      (g.group.name, url_for("group.show_group_page")),
      ("Tournaments", url_for("tournaments.index")),
      (data.tournament.name, "")
    ])
  }}
{% endblock %}

{% block content %}
  <h2 class="heading heading_primary">Tournament Page</h2>

  {% if data.is_admin %}
    <div class="admin-actions">
      <a class="admin-actions__item button button_action"
         href="{{ url_for('tournaments.edit_round', tournament_id=data.tournament.id, round_id=0) }}">
        Add Round
      </a>
    </div>
  {% endif %}

  <h3 class="heading heading_secondary">Rounds</h3>
  <div class="tabs" id="filterTabs"></div>
  <table class="table table--full-width my-3">
    <thead>
      <tr>
        <th width="5%">#</th>
        <th width="25%">Name</th>
        <th width="25%">Author</th>
        <th width="25%">Finish Time</th>
        <th width="10%">Played</th>
        <th width="10%">Actions</th>
      </tr>
    </thead>
    <tbody id="tableRows"></tbody>
  </table>

  <section class="my-4">
    <h3 class="heading heading_secondary">Overall Standings</h3>
    {% if data.tournament_standings %}
      <table class="results-table">
        <tr class="results-table__header-row">
          <td class="results-table__header-cell">#</td>
          <td class="results-table__header-cell">user</td>
          <td class="results-table__header-cell">rounds</td>
          <td class="results-table__header-cell">p/a</td>
          <td class="results-table__header-cell">points</td>
          <td class="results-table__header-cell">p/a</td>
        </tr>
        {% for obj in data.tournament_standings %}
          <tr class="results-table__row results-table__row_{{ loop.cycle('odd', 'even') }}
              {{ (obj.user_id == g.user.id and 'results-table__row_own') or '' }}">
            <td class="results-table__cell">{{ loop.index }}</td>
            <td class="results-table__cell">{{ obj.user }}</td>
            <td class="results-table__cell results-table__cell--centered">{{ obj.rounds }}</td>
            <td class="results-table__cell results-table__cell--centered">
                <small>{{ obj.rounds_played }}/{{ obj.rounds_authored }}</small>
            </td>
            <td class="results-table__cell results-table__cell--centered">{{ obj.points }}</td>
            <td class="results-table__cell results-table__cell--centered">
              <small>{{ obj.points_played }}/{{ obj.points_authored }}</small>
            </td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>Tournament standings will be here.</p>
    {% endif %}
  </section>
{% endblock %}

{% block bottom %}
<script>
  let filters = {{ data.filters|tojson }};
  let globalRounds = {{ data.rounds|tojson }};
  let hasEditPermissions = {{ data.is_admin|tojson }};

  const makeRoundRow = (round, num) => {
    const tr = document.createElement("tr");
    tr.className = "table__tr";
    tr.classList.add(((num + 1) % 2) ? "table__tr--odd" : "table__tr--even");

    const td1 = document.createElement("td");
    td1.className = "table__td table__td--centered";
    td1.innerHTML = num + 1;
    tr.append(td1);

    const td2 = document.createElement("td");
    td2.className = "table__td";
    td2.innerHTML = `<a href="${ round.view_url }">${ round.quiz.topic }</a>`;
    tr.append(td2);

    const td3 = document.createElement("td");
    td3.className = "table__td table__td--centered";
    td3.innerHTML = round.quiz.author;
    tr.append(td3);

    const td4 = document.createElement("td");
    td4.className = "table__td table__td--centered";
    const relTimeSpan = document.createElement("span");
    relTimeSpan.dataset.timestamp = round.finish_time;
    relTimeSpan.dataset.func = "fromNow";
    relTimeSpan.dataset.refresh = 10000;
    renderMomentDate(relTimeSpan); // adds innerHTML to element
    td4.append(relTimeSpan);
    tr.append(td4);

    const td5 = document.createElement("td");
    td5.className = "table__td table__td--centered";
    td5.innerHTML = (round.is_taken) ? "yes" : "no";
    tr.append(td5);

    const td6 = document.createElement("td");
    td6.className = "table__td table__td--centered";
    if (hasEditPermissions) td6.innerHTML = `<a href="${round.edit_url}">âœŽ</a>`;
    tr.append(td6);

    return tr;
  }

  const renderRows = (activeFilter) => {
    // apply current filter
    const rows = (activeFilter === "all")
      ? globalRounds
      : globalRounds.filter(r => r.status === activeFilter);

    // sort selected rows
    if (activeFilter === "finished" || activeFilter === "all") {
      rows.sort((a,b) => (a.finish_time > b.finish_time) ? -1 : 1);
    } else {
      rows.sort((a,b) => (a.finish_time > b.finish_time) ? 1 : -1);
    }

    // re-render
    const node = document.getElementById("tableRows");
    node.innerHTML = "";
    if (!rows.length) {
      const tr = document.createElement("tr");
      tr.className = "table__tr table__tr--odd";
      tr.innerHTML = '<td class="table__td" colspan="6">No rounds available.</td>';
      node.append(tr);
    } else {
      rows.forEach((r,i) => {
        node.append(makeRoundRow(r,i));
      })
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    addFilters(filters, "filterTabs", renderRows);
  });

</script>
{% endblock %}
